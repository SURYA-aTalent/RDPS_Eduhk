<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{fragments/template}">
<head>
    <title>TalentLink User Sync - RDPS</title>
    <style>
        .user-sync-container {
            padding: 20px;
        }
        .sync-header {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .sync-button {
            background-color: #28a745;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .sync-button:hover {
            background-color: #218838;
        }
        .sync-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result-box {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }
        .result-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .users-table th, .users-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        .users-table th {
            background-color: #007bff;
            color: white;
        }
        .users-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .badge {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-success {
            background-color: #28a745;
            color: white;
        }
        .badge-warning {
            background-color: #ffc107;
            color: black;
        }
        .badge-info {
            background-color: #17a2b8;
            color: white;
        }
        .loading {
            display: none;
            margin-left: 10px;
        }
        .info-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div layout:fragment="breadcrumb">
        <a th:href="@{/}" class="breadcrumb-item nav-link"><i class="icon-home2 mr-2"></i> Home</a>
        <span class="breadcrumb-item active">TalentLink User Sync</span>
    </div>

    <div layout:fragment="content">
        <div class="user-sync-container">
            <h2>TalentLink User Sync (SOAP API)</h2>

            <div class="sync-header">
                <h4>Sync Users to TalentLink</h4>
                <p>This page allows you to sync users from the staging table to TalentLink using SOAP API.</p>
                <p><strong>Note:</strong> Only users with status "N" (Not Synced) will be processed.</p>
            </div>

            <div class="info-box">
                <strong>API Type:</strong> SOAP Web Services<br>
                <strong>Endpoint:</strong> https://api3.lumesse-talenthub.com/User/SOAP/User<br>
                <strong>Authentication:</strong> WS-Security (Username Token)
            </div>

            <button class="sync-button" onclick="triggerSync()" id="syncButton">
                ▶ Trigger User Sync
            </button>
            <span class="loading" id="loading">⏳ Syncing users via SOAP...</span>

            <div class="result-box" id="resultBox"></div>

            <h3>Users in Staging Table</h3>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Synced</th>
                        <th>Sync Date</th>
                        <th>Sync Log</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="user : ${users}">
                        <td th:text="${user.userId}"></td>
                        <td th:text="${user.firstName + ' ' + user.lastName}"></td>
                        <td th:text="${user.email}"></td>
                        <td>
                            <span th:class="'badge badge-' + (${user.status == 'Active'} ? 'success' : 'info')"
                                  th:text="${user.status}"></span>
                        </td>
                        <td>
                            <span th:class="'badge badge-' + (${user.syncedToTalentlink == 'Y'} ? 'success' : 'warning')"
                                  th:text="${user.syncedToTalentlink == 'Y' ? 'Synced' : 'Not Synced'}"></span>
                        </td>
                        <td th:text="${user.syncDate != null ? #dates.format(user.syncDate, 'yyyy-MM-dd HH:mm') : '-'}"></td>
                        <td th:text="${user.syncLog != null ? user.syncLog : '-'}" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;"></td>
                    </tr>
                </tbody>
            </table>

            <div style="margin-top: 30px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                <strong>⚠️ Important Notes:</strong>
                <ul>
                    <li>Users must have a password set to be created in TalentLink</li>
                    <li>Inactive users will be deactivated in TalentLink</li>
                    <li>The sync job also runs automatically every hour at :00 minutes</li>
                    <li>Check the logs at <code>/logs/catalina.out</code> for detailed sync information</li>
                </ul>
            </div>
        </div>

        <script>
            function triggerSync() {
                const button = document.getElementById('syncButton');
                const loading = document.getElementById('loading');
                const resultBox = document.getElementById('resultBox');

                // Disable button and show loading
                button.disabled = true;
                loading.style.display = 'inline';
                resultBox.style.display = 'none';

                // Make AJAX request
                fetch('/RDPS/admin/user-sync/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                    }
                })
                .then(response => response.text())
                .then(result => {
                    // Show result
                    resultBox.innerHTML = '<strong>Sync Result:</strong><br>' + result;
                    resultBox.className = 'result-box result-success';
                    resultBox.style.display = 'block';

                    // Reload page after 2 seconds to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                })
                .catch(error => {
                    resultBox.innerHTML = '<strong>Error:</strong><br>' + error.message;
                    resultBox.className = 'result-box result-error';
                    resultBox.style.display = 'block';
                })
                .finally(() => {
                    button.disabled = false;
                    loading.style.display = 'none';
                });
            }
        </script>
    </div>
</body>
</html>
